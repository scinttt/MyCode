# ~/AI_Workspace/my_mcp_servers/preference_server.py
from mcp.server.fastmcp import FastMCP
import os
from datetime import datetime

# åˆ›å»ºä¸€ä¸ª MCP Server å®ä¾‹
mcp = FastMCP("PreferenceManager")

# åªéœ€è¦åŠ ä¸€ä¸ªè£…é¥°å™¨ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸º LLM å¯è§çš„ Tool
@mcp.tool()
def update_global_preference(category: str, new_preference: str) -> str:
    """
    å½“ç”¨æˆ·åœ¨å¯¹è¯ä¸­è¡¨è¾¾äº†ã€æ–°çš„é•¿æœŸåå¥½ã€‘ã€ã€æŠ€æœ¯æ ˆæ¼”è¿›ã€‘æˆ–ã€æ ¸å¿ƒç„¦ç‚¹çš„è½¬ç§»ã€‘æ—¶ï¼Œå¿…é¡»è°ƒç”¨æ­¤å·¥å…·å¯¹çŠ¶æ€æ•°æ®åº“ (USER.md) è¿›è¡ŒæŒä¹…åŒ–æ›´æ–°ã€‚

    ã€ğŸ”´ æ ¸å¿ƒçº¢çº¿ä¸æ’é™¤é¡¹ã€‘ï¼š
    ä½ çš„å…¨å±€ System Instruction ä¸­å·²ç»å›ºåŒ–äº†ç”¨æˆ·çš„é™æ€åŸºç¡€ç”»åƒï¼ˆåŒ…æ‹¬ï¼šå…¨æ ˆå·¥ç¨‹å¸ˆèº«ä»½ã€Java/Python åŸºå‡†æŠ€èƒ½ã€macOS/Linux ç¯å¢ƒåå¥½ã€ç²¾å‡†é•¿å‘½åè§„èŒƒã€è‹±æ–‡ä»£ç /ä¸­æ–‡è¯´æ˜çš„è®¾å®šç­‰ï¼‰ã€‚
    **ç»å¯¹ä¸å…è®¸å°†ä¸Šè¿°ä»»ä½•é™æ€åŸºç¡€ä¿¡æ¯é‡å¤å†™å…¥æ­¤æ–‡ä»¶ã€‚**
    åŒæ—¶ï¼Œå¿…é¡»å¿½ç•¥ä¸€æ¬¡æ€§çš„ä¸­çŸ­æœŸ bug ä¿®å¤æˆ–å•æ¬¡é¡¹ç›®éœ€æ±‚ã€‚

    ã€ğŸŸ¢ æ•è·èŒƒå›´ã€‘ï¼ˆä»…é™åŠ¨æ€å˜åŒ–ä¸å¢é‡ï¼‰ï¼š
    1. CurrentFocus (è¿‘æœŸæ ¸å¿ƒèšç„¦)ï¼šå¦‚å½“å‰æ­£åœ¨æ”»å…‹çš„ç‰¹å®šä¸šåŠ¡éš¾ç‚¹ï¼ˆå¦‚è®¢å•è‡ªåŠ¨åŒ–å½•å…¥ï¼‰ã€çŸ­æœŸå†…çš„å…³é”®æŠ€æœ¯é‡Œç¨‹ç¢‘ã€‚
    2. EvolvingInterests (æ¼”è¿›ä¸­çš„å…´è¶£)ï¼šå¦‚æ–°å¼€å§‹æ·±å…¥ç ”ç©¶çš„å…·ä½“æ¡†æ¶ï¼ˆå¦‚ LangGraph, Multi-agent æ¶æ„ï¼‰ã€æ–°çš„æ¢ç´¢æ–¹å‘ã€‚
    3. WorkflowContext (å·¥ä½œæµä¸Šä¸‹æ–‡å˜æ›´)ï¼šå¦‚æ–°å¼•å…¥çš„ç‰¹å®šå¼€å‘å·¥å…·ç»„åˆã€é’ˆå¯¹ç‰¹å®šä¸šåŠ¡åœºæ™¯çš„æ²Ÿé€šé£æ ¼å¾®è°ƒã€‚
   
    ã€âš™ï¸ å¼ºåˆ¶è¦†ç›–åˆå¹¶æœºåˆ¶ (Upsert Logic)ã€‘ï¼š
    å†™å…¥æ“ä½œå¿…é¡»éµå¾ªâ€œè¯»å– -> æ•´åˆ -> æ›¿æ¢â€çš„é€»è¾‘ã€‚å¦‚æœæ–°æå–çš„ä¿¡æ¯ä¸ç°æœ‰å†…å®¹åŒç±»ã€é‡å¤æˆ–å‘ç”ŸçŠ¶æ€å†²çªï¼ˆä¾‹å¦‚ç„¦ç‚¹ä» A è½¬ç§»åˆ°äº† Bï¼‰ï¼Œ**å¿…é¡»è¿›è¡Œé€»è¾‘æ•´åˆä¸æ›¿æ¢ï¼Œä¸¥ç¦æ— è„‘åœ¨æ–‡ä»¶å°¾éƒ¨è¿½åŠ  (Append)**ã€‚å§‹ç»ˆä¿æŒ USER.md çš„æè‡´ç²¾ç®€å’Œé«˜ä¿¡æ¯å¯†åº¦ã€‚

    å‚æ•° category åº”å½“ç®€æ˜æ‰¼è¦ï¼Œå¼ºåˆ¶ä½¿ç”¨ä»¥ä¸‹æšä¸¾å€¼ä¹‹ä¸€: 'CurrentFocus', 'EvolvingInterests', 'WorkflowContext'ã€‚
    """ 
    file_path = os.path.expanduser("~/God/USER.md")
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    entry = f"\n- **[{category}]** {new_preference} (Updated: {timestamp})"
    
    with open(file_path, "a", encoding="utf-8") as f:
        f.write(entry)
        
    return "SUCCESS: Preference updated."

if __name__ == "__main__":
    mcp.run()
